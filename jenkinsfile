pipeline {
    agent any
     //tools {
        // Define JDK tool installation
       // jdk 'JDK 11'
    //}

    environment {
            DOCKER_REGISTRY_CREDENTIALS = credentials('dockerhub') // This assumes you've set up Jenkins credentials for your Docker registry
            DOCKER_IMAGE_NAME = 'hemu369/spring-boot-demo:latest'
            REMOTE_SERVER_USERNAME = 'ubuntu'
            REMOTE_SERVER_ADDRESS = '172.31.28.64'
        }
    
    stages {
        
        stage('Build') {
            steps {
                // Build your Spring Boot application
                dir('csc') {
                sh "mvn clean install" // Assuming you're using Maven for your build
                }
            }
        }

        stage('Docker Build and Push') {
                    steps {
                        // Build Docker image
                        script {
                            docker.build(env.DOCKER_IMAGE_NAME)
                                docker.withRegistry('', "dockerhub") {
                                    // Push Docker image to registry
                                    docker.image(env.DOCKER_IMAGE_NAME).push()
                                }
                            }
                    }
                }
//         stage('Build and Push Docker Image') {
//               environment {
//                 DOCKER_IMAGE = "ganjivasu/ultimate-cicd:${BUILD_NUMBER}"
//                 // DOCKERFILE_LOCATION = "java-maven-sonar-argocd-helm-k8s/spring-boot-app/Dockerfile"
//                 REGISTRY_CREDENTIALS = credentials('docker-cred')
//               }
//               steps {
//                 script {
//                     sh 'cd java-maven-sonar-argocd-helm-k8s/spring-boot-app && docker build -t ${DOCKER_IMAGE} .'
//                     def dockerImage = docker.image("${DOCKER_IMAGE}")
//                     docker.withRegistry('https://index.docker.io/v1/', "docker-cred") {
//                         dockerImage.push()
//                     }
//                 }
//               }
//             }
        
        stage('Deploy') {
                    steps {
                        // SSH into the target EC2 instance and pull the Docker image
                        sshagent(credentials: ['ec2-spring']) {
                            echo "------------------- pull started ---------------------"
                            docker.withRegistry('', "dockerhub") {
                                sh "ssh -o StrictHostKeyChecking=no ${env.REMOTE_SERVER_USERNAME}@${env.REMOTE_SERVER_ADDRESS} 'docker pull ${env.DOCKER_IMAGE_NAME}'"
                            }
                            echo "------------------- pull success ---------------------"
                            sh "ssh -o StrictHostKeyChecking=no ${env.REMOTE_SERVER_USERNAME}@${env.REMOTE_SERVER_ADDRESS} 'docker run -d -p 8080:8080 ${env.DOCKER_IMAGE_NAME}'"
                        }
                    }
                }
    }
}
